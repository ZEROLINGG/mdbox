# å¸å®‰åˆçº¦æ‰¹é‡ä¸‹å• - æœ€å°‘è¯·æ±‚æ–¹æ¡ˆ

## ğŸ“Œ ç»“è®º

| æ“ä½œ           | èƒ½å¦åˆå¹¶     | è¯´æ˜                             |
| ------------ | -------- | ------------------------------ |
| æ æ†è®¾ç½®         | âŒ å¿…é¡»å•ç‹¬è¯·æ±‚ | ä½†åªéœ€è®¾ç½®ä¸€æ¬¡ï¼Œä¹‹åæ— éœ€é‡å¤                 |
| å¼€ä»“ + æ­¢ç›ˆ + æ­¢æŸ | âœ… å¯ä»¥åˆå¹¶   | ä½¿ç”¨ `/fapi/v1/batchOrders` æ‰¹é‡ä¸‹å• |

**æœ€ä¼˜æ–¹æ¡ˆï¼š2æ¬¡è¯·æ±‚ï¼ˆå¦‚æœæ æ†å·²è®¾ç½®è¿‡ï¼Œåˆ™åªéœ€1æ¬¡ï¼‰**

---

## ğŸš€ æ‰¹é‡ä¸‹å•æ¥å£

### ç«¯ç‚¹ä¿¡æ¯
```
POST /fapi/v1/batchOrders
```

### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| batchOrders | LIST | âœ… | è®¢å•åˆ—è¡¨ï¼ŒJSONæ ¼å¼ï¼Œæœ€å¤š5ä¸ªè®¢å• |
| timestamp | LONG | âœ… | æ—¶é—´æˆ³ |
| signature | STRING | âœ… | ç­¾å |

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

```python
import hashlib
import hmac
import time
import json
import requests
from urllib.parse import urlencode, quote

# ============ é…ç½® ============
API_KEY = 'your_api_key'
API_SECRET = 'your_api_secret'
BASE_URL = 'https://fapi.binance.com'

# ============ åŸºç¡€å‡½æ•° ============
def get_signature(params):
    query_string = urlencode(params)
    signature = hmac.new(
        API_SECRET.encode('utf-8'),
        query_string.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return signature

def send_signed_request(method, endpoint, params=None):
    if params is None:
        params = {}
    
    params['timestamp'] = int(time.time() * 1000)
    params['recvWindow'] = 5000
    params['signature'] = get_signature(params)
    
    headers = {'X-MBX-APIKEY': API_KEY}
    url = BASE_URL + endpoint
    
    if method == 'POST':
        response = requests.post(url, headers=headers, params=params)
    
    return response.json()

# ============ æ æ†è®¾ç½®ï¼ˆåªéœ€è°ƒç”¨ä¸€æ¬¡ï¼‰============
def set_leverage(symbol, leverage):
    """è®¾ç½®æ æ† - å¿…é¡»å•ç‹¬è¯·æ±‚ï¼Œä½†åªéœ€è®¾ç½®ä¸€æ¬¡"""
    params = {
        'symbol': symbol,
        'leverage': leverage
    }
    return send_signed_request('POST', '/fapi/v1/leverage', params)


# ============ æ ¸å¿ƒï¼šæ‰¹é‡ä¸‹å•å‡½æ•° ============
def batch_orders(orders_list):
    """
    æ‰¹é‡ä¸‹å• - ä¸€æ¬¡è¯·æ±‚æœ€å¤š5ä¸ªè®¢å•
    orders_list: è®¢å•å­—å…¸åˆ—è¡¨
    """
    params = {
        'batchOrders': json.dumps(orders_list)
    }
    return send_signed_request('POST', '/fapi/v1/batchOrders', params)


# ============ ä¸€é”®å¼€ä»“ï¼ˆå¼€ä»“+æ­¢ç›ˆ+æ­¢æŸï¼‰============
def open_short_with_tp_sl(
    symbol,
    quantity,
    entry_price,      # å¼€ä»“é™ä»·
    take_profit_price,  # æ­¢ç›ˆä»·æ ¼
    stop_loss_price     # æ­¢æŸä»·æ ¼
):
    """
    å¼€ç©º + æ­¢ç›ˆ + æ­¢æŸ - ä¸€æ¬¡è¯·æ±‚å®Œæˆ
    """
    orders = [
        # è®¢å•1: é™ä»·å¼€ç©º
        {
            "symbol": symbol,
            "side": "SELL",
            "positionSide": "SHORT",
            "type": "LIMIT",
            "quantity": str(quantity),
            "price": str(entry_price),
            "timeInForce": "GTC"
        },
        # è®¢å•2: æ­¢ç›ˆï¼ˆå¸‚ä»·ï¼‰
        {
            "symbol": symbol,
            "side": "BUY",
            "positionSide": "SHORT",
            "type": "TAKE_PROFIT_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(take_profit_price),
            "workingType": "MARK_PRICE"
        },
        # è®¢å•3: æ­¢æŸï¼ˆå¸‚ä»·ï¼‰
        {
            "symbol": symbol,
            "side": "BUY",
            "positionSide": "SHORT",
            "type": "STOP_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(stop_loss_price),
            "workingType": "MARK_PRICE"
        }
    ]
    
    return batch_orders(orders)


def open_long_with_tp_sl(
    symbol,
    quantity,
    entry_price,
    take_profit_price,
    stop_loss_price
):
    """
    å¼€å¤š + æ­¢ç›ˆ + æ­¢æŸ - ä¸€æ¬¡è¯·æ±‚å®Œæˆ
    """
    orders = [
        # è®¢å•1: é™ä»·å¼€å¤š
        {
            "symbol": symbol,
            "side": "BUY",
            "positionSide": "LONG",
            "type": "LIMIT",
            "quantity": str(quantity),
            "price": str(entry_price),
            "timeInForce": "GTC"
        },
        # è®¢å•2: æ­¢ç›ˆ
        {
            "symbol": symbol,
            "side": "SELL",
            "positionSide": "LONG",
            "type": "TAKE_PROFIT_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(take_profit_price),
            "workingType": "MARK_PRICE"
        },
        # è®¢å•3: æ­¢æŸ
        {
            "symbol": symbol,
            "side": "SELL",
            "positionSide": "LONG",
            "type": "STOP_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(stop_loss_price),
            "workingType": "MARK_PRICE"
        }
    ]
    
    return batch_orders(orders)
```

---

## ğŸ¯ ä½ çš„ä¾‹å­ï¼šå¼€ç©º BTCUSDT

```python
# ============ ä½ çš„äº¤æ˜“ç¤ºä¾‹ ============

# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼šè®¾ç½®æ æ†ï¼ˆåªéœ€è®¾ç½®ä¸€æ¬¡ï¼Œä¹‹åå¯è·³è¿‡ï¼‰
print("è®¾ç½®æ æ† 30x...")
leverage_result = set_leverage('BTCUSDT', 30)
print(f"æ æ†è®¾ç½®ç»“æœ: {leverage_result}")

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼šå¼€ä»“ + æ­¢ç›ˆ + æ­¢æŸï¼ˆä¸€æ¬¡å®Œæˆï¼‰
print("\næ‰¹é‡ä¸‹å•ï¼šå¼€ç©º + æ­¢ç›ˆ + æ­¢æŸ...")
result = open_short_with_tp_sl(
    symbol='BTCUSDT',
    quantity=0.01,
    entry_price=87367.4,      # å¼€ä»“é™ä»·
    take_profit_price=87365.4, # æ­¢ç›ˆï¼ˆä»·æ ¼ä¸‹è·Œç›ˆåˆ©ï¼‰
    stop_loss_price=87371.4    # æ­¢æŸï¼ˆä»·æ ¼ä¸Šæ¶¨æ­¢æŸï¼‰
)
print(f"æ‰¹é‡ä¸‹å•ç»“æœ: {json.dumps(result, indent=2)}")
```

---

## ğŸ“‹ æ‰¹é‡ä¸‹å•å“åº”ç¤ºä¾‹

### æˆåŠŸå“åº”

```json
[
    {
        "orderId": 8389765522916710001,
        "symbol": "BTCUSDT",
        "status": "NEW",
        "clientOrderId": "batch_order_1",
        "price": "87367.40",
        "avgPrice": "0.00",
        "origQty": "0.010",
        "executedQty": "0.000",
        "cumQuote": "0.00",
        "timeInForce": "GTC",
        "type": "LIMIT",
        "reduceOnly": false,
        "side": "SELL",
        "positionSide": "SHORT",
        "stopPrice": "0.00",
        "workingType": "CONTRACT_PRICE",
        "origType": "LIMIT",
        "updateTime": 1699123456789
    },
    {
        "orderId": 8389765522916710002,
        "symbol": "BTCUSDT",
        "status": "NEW",
        "clientOrderId": "batch_order_2",
        "price": "0.00",
        "avgPrice": "0.00",
        "origQty": "0.010",
        "executedQty": "0.000",
        "cumQuote": "0.00",
        "timeInForce": "GTC",
        "type": "TAKE_PROFIT_MARKET",
        "reduceOnly": false,
        "side": "BUY",
        "positionSide": "SHORT",
        "stopPrice": "87365.40",
        "workingType": "MARK_PRICE",
        "origType": "TAKE_PROFIT_MARKET",
        "updateTime": 1699123456790
    },
    {
        "orderId": 8389765522916710003,
        "symbol": "BTCUSDT",
        "status": "NEW",
        "clientOrderId": "batch_order_3",
        "price": "0.00",
        "avgPrice": "0.00",
        "origQty": "0.010",
        "executedQty": "0.000",
        "cumQuote": "0.00",
        "timeInForce": "GTC",
        "type": "STOP_MARKET",
        "reduceOnly": false,
        "side": "BUY",
        "positionSide": "SHORT",
        "stopPrice": "87371.40",
        "workingType": "MARK_PRICE",
        "origType": "STOP_MARKET",
        "updateTime": 1699123456791
    }
]
```

### éƒ¨åˆ†å¤±è´¥å“åº”

```json
[
    {
        "orderId": 8389765522916710001,
        "symbol": "BTCUSDT",
        "status": "NEW",
        ...
    },
    {
        "code": -2019,
        "msg": "Margin is insufficient."
    },
    {
        "code": -2019,
        "msg": "Margin is insufficient."
    }
]
```

---

## ğŸ”§ è¿›é˜¶ï¼šå¸‚ä»·å¼€ä»“ç‰ˆæœ¬

```python
def open_short_market_with_tp_sl(
    symbol,
    quantity,
    take_profit_price,
    stop_loss_price
):
    """å¸‚ä»·å¼€ç©º + æ­¢ç›ˆ + æ­¢æŸ"""
    orders = [
        # å¸‚ä»·å¼€ç©º
        {
            "symbol": symbol,
            "side": "SELL",
            "positionSide": "SHORT",
            "type": "MARKET",
            "quantity": str(quantity)
        },
        # æ­¢ç›ˆ
        {
            "symbol": symbol,
            "side": "BUY",
            "positionSide": "SHORT",
            "type": "TAKE_PROFIT_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(take_profit_price),
            "workingType": "MARK_PRICE"
        },
        # æ­¢æŸ
        {
            "symbol": symbol,
            "side": "BUY",
            "positionSide": "SHORT",
            "type": "STOP_MARKET",
            "quantity": str(quantity),
            "stopPrice": str(stop_loss_price),
            "workingType": "MARK_PRICE"
        }
    ]
    
    return batch_orders(orders)

# ä½¿ç”¨
result = open_short_market_with_tp_sl(
    symbol='BTCUSDT',
    quantity=0.01,
    take_profit_price=85000,  # æ­¢ç›ˆ
    stop_loss_price=88000     # æ­¢æŸ
)
```

---

## ğŸ“Š è¯·æ±‚æ¬¡æ•°å¯¹æ¯”

| æ–¹æ¡ˆ | è¯·æ±‚æ¬¡æ•° | è¯´æ˜ |
|------|----------|------|
| åŸå§‹æ–¹æ¡ˆ | 4-5æ¬¡ | æ æ†+ä¿è¯é‡‘æ¨¡å¼+å¼€ä»“+æ­¢ç›ˆ+æ­¢æŸ |
| **ä¼˜åŒ–æ–¹æ¡ˆ** | **1-2æ¬¡** | æ æ†(å¯é€‰) + æ‰¹é‡ä¸‹å• |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ æ†åªéœ€è®¾ç½®ä¸€æ¬¡**ï¼šå¦‚æœä¹‹å‰å·²è®¾ç½®è¿‡30xï¼Œæ— éœ€é‡å¤è°ƒç”¨
2. **æ‰¹é‡æœ€å¤š5å•**ï¼šè¶³å¤Ÿ å¼€ä»“+æ­¢ç›ˆ+æ­¢æŸ+è¿½åŠ å•
3. **åŒå‘æŒä»“æ¨¡å¼**ï¼šéœ€æå‰è®¾ç½®ï¼Œä½†ä¹Ÿåªéœ€è®¾ç½®ä¸€æ¬¡
4. **æ­¢ç›ˆæ­¢æŸè§¦å‘**ï¼šä½¿ç”¨ `MARK_PRICE` æ›´ç¨³å®šï¼Œé¿å…æ’é’ˆ
5. **éƒ¨åˆ†å¤±è´¥**ï¼šæ‰¹é‡è®¢å•ä¸­æŸä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–è®¢å•