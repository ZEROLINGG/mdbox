# 币安 U 本位合约 API 使用指南 (Python)

## 1. 环境准备

```python
import hashlib
import hmac
import time
import requests
from urllib.parse import urlencode

# API 配置
API_KEY = 'your_api_key'
API_SECRET = 'your_api_secret'
BASE_URL = 'https://fapi.binance.com'  # U本位合约正式环境
# BASE_URL = 'https://testnet.binancefuture.com'  # 测试网

def create_signature(params, secret):
    """创建签名"""
    query_string = urlencode(params)
    signature = hmac.new(
        secret.encode('utf-8'),
        query_string.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return signature

def send_signed_request(method, endpoint, params=None):
    """发送签名请求"""
    if params is None:
        params = {}
    
    params['timestamp'] = int(time.time() * 1000)
    params['signature'] = create_signature(params, API_SECRET)
    
    headers = {'X-MBX-APIKEY': API_KEY}
    url = BASE_URL + endpoint
    
    if method == 'GET':
        response = requests.get(url, headers=headers, params=params)
    elif method == 'POST':
        response = requests.post(url, headers=headers, params=params)
    elif method == 'DELETE':
        response = requests.delete(url, headers=headers, params=params)
    
    return response.json()
```

---

## 2. 设置杠杆

```python
def set_leverage(symbol, leverage):
    """
    设置杠杆倍数
    
    参数:
    - symbol: 交易对 (必需)
    - leverage: 杠杆倍数 1-125 (必需)
    """
    endpoint = '/fapi/v1/leverage'
    params = {
        'symbol': symbol,
        'leverage': leverage
    }
    return send_signed_request('POST', endpoint, params)

# 示例：设置 BTCUSDT 20倍杠杆
result = set_leverage('BTCUSDT', 20)
print(result)
```

### 请求参数
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| symbol | STRING | YES | 交易对，如 BTCUSDT |
| leverage | INT | YES | 杠杆倍数，1-125 |
| timestamp | LONG | YES | 时间戳 |
| signature | STRING | YES | 签名 |

### 响应示例
```json
{
    "leverage": 20,
    "maxNotionalValue": "1000000",
    "symbol": "BTCUSDT"
}
```

---

## 3. 设置保证金模式

```python
def set_margin_type(symbol, margin_type):
    """
    设置保证金模式
    
    参数:
    - symbol: 交易对
    - margin_type: ISOLATED(逐仓) 或 CROSSED(全仓)
    """
    endpoint = '/fapi/v1/marginType'
    params = {
        'symbol': symbol,
        'marginType': margin_type
    }
    return send_signed_request('POST', endpoint, params)

# 示例：设置为逐仓模式
result = set_margin_type('BTCUSDT', 'ISOLATED')
print(result)
```

### 响应示例
```json
{
    "code": 200,
    "msg": "success"
}
```

---

## 4. 开仓下单

### 4.1 市价开多（做多）

```python
def open_long_market(symbol, quantity):
    """
    市价开多
    
    参数:
    - symbol: 交易对
    - quantity: 数量
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',           # 买入
        'positionSide': 'LONG',  # 多仓（双向持仓模式）
        'type': 'MARKET',        # 市价单
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)

# 示例：市价开多 0.01 BTC
result = open_long_market('BTCUSDT', 0.01)
print(result)
```

### 4.2 市价开空（做空）

```python
def open_short_market(symbol, quantity):
    """
    市价开空
    
    参数:
    - symbol: 交易对
    - quantity: 数量
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',           # 卖出
        'positionSide': 'SHORT',  # 空仓（双向持仓模式）
        'type': 'MARKET',
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)

# 示例：市价开空 0.01 BTC
result = open_short_market('BTCUSDT', 0.01)
print(result)
```

### 4.3 限价开多

```python
def open_long_limit(symbol, quantity, price):
    """
    限价开多
    
    参数:
    - symbol: 交易对
    - quantity: 数量
    - price: 限价价格
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',
        'positionSide': 'LONG',
        'type': 'LIMIT',
        'quantity': quantity,
        'price': price,
        'timeInForce': 'GTC'  # Good Till Cancel
    }
    return send_signed_request('POST', endpoint, params)

# 示例：在 60000 USDT 限价开多 0.01 BTC
result = open_long_limit('BTCUSDT', 0.01, 60000)
print(result)
```

### 4.4 限价开空

```python
def open_short_limit(symbol, quantity, price):
    """
    限价开空
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',
        'positionSide': 'SHORT',
        'type': 'LIMIT',
        'quantity': quantity,
        'price': price,
        'timeInForce': 'GTC'
    }
    return send_signed_request('POST', endpoint, params)

# 示例：在 70000 USDT 限价开空 0.01 BTC
result = open_short_limit('BTCUSDT', 0.01, 70000)
print(result)
```

---

## 5. 下单请求参数完整说明

| 参数               | 类型      | 必需  | 描述                                      |
| ---------------- | ------- | --- | --------------------------------------- |
| symbol           | STRING  | YES | 交易对，如 BTCUSDT                           |
| side             | ENUM    | YES | BUY(买) / SELL(卖)                        |
| positionSide     | ENUM    | NO  | LONG(多) / SHORT(空) / BOTH(单向持仓)         |
| type             | ENUM    | YES | 订单类型                                    |
| quantity         | DECIMAL | NO  | 下单数量                                    |
| price            | DECIMAL | NO  | 委托价格（限价单必需）                             |
| stopPrice        | DECIMAL | NO  | 触发价格（止盈止损单必需）                           |
| timeInForce      | ENUM    | NO  | 有效方式                                    |
| reduceOnly       | STRING  | NO  | true/false 仅减仓                          |
| newClientOrderId | STRING  | NO  | 自定义订单ID                                 |
| closePosition    | STRING  | NO  | true/false 触发后全部平仓                      |
| workingType      | ENUM    | NO  | MARK_PRICE(标记价格) / CONTRACT_PRICE(最新价格) |
| newOrderRespType | ENUM    | NO  | ACK / RESULT                            |
| timestamp        | LONG    | YES | 时间戳                                     |
| signature        | STRING  | YES | 签名                                      |

### 订单类型 (type)
| 类型                   | 描述    |
| -------------------- | ----- |
| LIMIT                | 限价单   |
| MARKET               | 市价单   |
| STOP                 | 止损限价单 |
| STOP_MARKET          | 止损市价单 |
| TAKE_PROFIT          | 止盈限价单 |
| TAKE_PROFIT_MARKET   | 止盈市价单 |
| TRAILING_STOP_MARKET | 跟踪止损单 |

### timeInForce 有效方式
| 值   | 描述         |
| --- | ---------- |
| GTC | 成交为止       |
| IOC | 无法立即成交部分取消 |
| FOK | 全部成交或取消    |
| GTX | 只做maker    |
| GTD | 指定时间前有效    |

---

## 6. 下单响应示例

```json
{
    "clientOrderId": "testOrder",
    "cumQty": "0",
    "cumQuote": "0",
    "executedQty": "0",
    "orderId": 22542179,
    "avgPrice": "0.00000",
    "origQty": "0.01",
    "price": "60000",
    "reduceOnly": false,
    "side": "BUY",
    "positionSide": "LONG",
    "status": "NEW",
    "stopPrice": "0",
    "closePosition": false,
    "symbol": "BTCUSDT",
    "timeInForce": "GTC",
    "type": "LIMIT",
    "origType": "LIMIT",
    "activatePrice": null,
    "priceRate": null,
    "updateTime": 1566818724722,
    "workingType": "CONTRACT_PRICE",
    "priceProtect": false
}
```

### 订单状态 (status)
| 状态               | 描述   |
| ---------------- | ---- |
| NEW              | 新订单  |
| PARTIALLY_FILLED | 部分成交 |
| FILLED           | 完全成交 |
| CANCELED         | 已取消  |
| REJECTED         | 被拒绝  |
| EXPIRED          | 已过期  |

---

## 7. 设置止盈止损

### 7.1 为多仓设置止盈止损

```python
def set_long_take_profit(symbol, quantity, stop_price):
    """
    多仓止盈（价格上涨到 stop_price 时平多）
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',              # 平多用卖
        'positionSide': 'LONG',
        'type': 'TAKE_PROFIT_MARKET',
        'quantity': quantity,
        'stopPrice': stop_price,
        'workingType': 'MARK_PRICE'  # 使用标记价格触发
    }
    return send_signed_request('POST', endpoint, params)

def set_long_stop_loss(symbol, quantity, stop_price):
    """
    多仓止损（价格下跌到 stop_price 时平多）
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',
        'positionSide': 'LONG',
        'type': 'STOP_MARKET',
        'quantity': quantity,
        'stopPrice': stop_price,
        'workingType': 'MARK_PRICE'
    }
    return send_signed_request('POST', endpoint, params)

# 示例：多仓在 65000 止盈，58000 止损
tp_result = set_long_take_profit('BTCUSDT', 0.01, 65000)
sl_result = set_long_stop_loss('BTCUSDT', 0.01, 58000)
```

### 7.2 为空仓设置止盈止损

```python
def set_short_take_profit(symbol, quantity, stop_price):
    """
    空仓止盈（价格下跌到 stop_price 时平空）
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',               # 平空用买
        'positionSide': 'SHORT',
        'type': 'TAKE_PROFIT_MARKET',
        'quantity': quantity,
        'stopPrice': stop_price,
        'workingType': 'MARK_PRICE'
    }
    return send_signed_request('POST', endpoint, params)

def set_short_stop_loss(symbol, quantity, stop_price):
    """
    空仓止损（价格上涨到 stop_price 时平空）
    """
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',
        'positionSide': 'SHORT',
        'type': 'STOP_MARKET',
        'quantity': quantity,
        'stopPrice': stop_price,
        'workingType': 'MARK_PRICE'
    }
    return send_signed_request('POST', endpoint, params)

# 示例：空仓在 55000 止盈，72000 止损
tp_result = set_short_take_profit('BTCUSDT', 0.01, 55000)
sl_result = set_short_stop_loss('BTCUSDT', 0.01, 72000)
```

### 7.3 全仓止盈止损（closePosition）

```python
def set_full_position_sl_tp(symbol, position_side, stop_price, order_type):
    """
    全仓止盈止损 - 触发后平掉全部仓位
    
    参数:
    - position_side: LONG 或 SHORT
    - order_type: STOP_MARKET(止损) 或 TAKE_PROFIT_MARKET(止盈)
    """
    endpoint = '/fapi/v1/order'
    
    side = 'SELL' if position_side == 'LONG' else 'BUY'
    
    params = {
        'symbol': symbol,
        'side': side,
        'positionSide': position_side,
        'type': order_type,
        'closePosition': 'true',    # 关键参数：全部平仓
        'stopPrice': stop_price,
        'workingType': 'MARK_PRICE'
    }
    return send_signed_request('POST', endpoint, params)

# 示例：多仓全部止损
result = set_full_position_sl_tp('BTCUSDT', 'LONG', 58000, 'STOP_MARKET')
```

---

## 8. 单向持仓模式

如果使用**单向持仓模式**（默认），不需要指定 `positionSide`：

```python
def open_long_market_oneway(symbol, quantity):
    """单向持仓 - 开多"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',
        'type': 'MARKET',
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)

def open_short_market_oneway(symbol, quantity):
    """单向持仓 - 开空"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',
        'type': 'MARKET',
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)

def close_long_market_oneway(symbol, quantity):
    """单向持仓 - 平多"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',
        'type': 'MARKET',
        'quantity': quantity,
        'reduceOnly': 'true'  # 仅减仓
    }
    return send_signed_request('POST', endpoint, params)
```

### 切换持仓模式

```python
def change_position_mode(dual_side_position):
    """
    切换持仓模式
    
    参数:
    - dual_side_position: true(双向持仓) / false(单向持仓)
    """
    endpoint = '/fapi/v1/positionSide/dual'
    params = {
        'dualSidePosition': str(dual_side_position).lower()
    }
    return send_signed_request('POST', endpoint, params)

# 切换到双向持仓模式
result = change_position_mode(True)
```

---

## 9. 平仓操作

### 9.1 市价平多

```python
def close_long_market(symbol, quantity):
    """市价平多"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'SELL',           # 平多用卖
        'positionSide': 'LONG',
        'type': 'MARKET',
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)
```

### 9.2 市价平空

```python
def close_short_market(symbol, quantity):
    """市价平空"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'side': 'BUY',            # 平空用买
        'positionSide': 'SHORT',
        'type': 'MARKET',
        'quantity': quantity
    }
    return send_signed_request('POST', endpoint, params)
```

---

## 10. 查询订单和持仓

```python
def get_open_orders(symbol=None):
    """查询当前挂单"""
    endpoint = '/fapi/v1/openOrders'
    params = {}
    if symbol:
        params['symbol'] = symbol
    return send_signed_request('GET', endpoint, params)

def get_position_info(symbol=None):
    """查询持仓信息"""
    endpoint = '/fapi/v2/positionRisk'
    params = {}
    if symbol:
        params['symbol'] = symbol
    return send_signed_request('GET', endpoint, params)

def get_account_info():
    """查询账户信息"""
    endpoint = '/fapi/v2/account'
    return send_signed_request('GET', endpoint)

def cancel_order(symbol, order_id):
    """取消订单"""
    endpoint = '/fapi/v1/order'
    params = {
        'symbol': symbol,
        'orderId': order_id
    }
    return send_signed_request('DELETE', endpoint, params)
```

### 持仓信息响应示例

```json
[
    {
        "symbol": "BTCUSDT",
        "positionAmt": "0.010",
        "entryPrice": "60000.0",
        "markPrice": "61000.00000000",
        "unRealizedProfit": "10.00000000",
        "liquidationPrice": "55000.00000000",
        "leverage": "20",
        "maxNotionalValue": "1000000",
        "marginType": "isolated",
        "isolatedMargin": "30.00000000",
        "isAutoAddMargin": "false",
        "positionSide": "LONG",
        "notional": "610.00000000",
        "isolatedWallet": "30.00000000",
        "updateTime": 1625474304765
    }
]
```

---

## 11. 完整交易示例

```python
def full_trading_example():
    """完整交易流程示例"""
    symbol = 'BTCUSDT'
    
    # 1. 设置杠杆
    print("设置杠杆...")
    leverage_result = set_leverage(symbol, 10)
    print(f"杠杆设置结果: {leverage_result}")
    
    # 2. 设置保证金模式（逐仓）
    print("\n设置保证金模式...")
    try:
        margin_result = set_margin_type(symbol, 'ISOLATED')
        print(f"保证金模式设置结果: {margin_result}")
    except Exception as e:
        print(f"保证金模式可能已设置: {e}")
    
    # 3. 市价开多
    print("\n市价开多...")
    open_result = open_long_market(symbol, 0.001)
    print(f"开仓结果: {open_result}")
    
    # 4. 设置止盈止损
    print("\n设置止盈止损...")
    tp_result = set_long_take_profit(symbol, 0.001, 70000)
    print(f"止盈设置结果: {tp_result}")
    
    sl_result = set_long_stop_loss(symbol, 0.001, 55000)
    print(f"止损设置结果: {sl_result}")
    
    # 5. 查询持仓
    print("\n查询持仓...")
    position = get_position_info(symbol)
    print(f"持仓信息: {position}")
    
    # 6. 查询挂单
    print("\n查询挂单...")
    orders = get_open_orders(symbol)
    print(f"当前挂单: {orders}")

if __name__ == '__main__':
    full_trading_example()
```

---

## 12. 开多/开空 速查表

| 操作 | side | positionSide (双向) | 说明 |
|------|------|---------------------|------|
| 开多 | BUY | LONG | 买入开多仓 |
| 开空 | SELL | SHORT | 卖出开空仓 |
| 平多 | SELL | LONG | 卖出平多仓 |
| 平空 | BUY | SHORT | 买入平空仓 |
| 多仓止盈 | SELL | LONG | 价格上涨触发 |
| 多仓止损 | SELL | LONG | 价格下跌触发 |
| 空仓止盈 | BUY | SHORT | 价格下跌触发 |
| 空仓止损 | BUY | SHORT | 价格上涨触发 |