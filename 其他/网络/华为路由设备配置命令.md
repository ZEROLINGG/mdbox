# 华为路由设备配置命令完整详解

---

## 一、命令行基础与视图

### 1.1 视图层次结构详解

```bash
# 视图层次关系
用户视图 <Huawei>
    ├── 系统视图 [Huawei]
    │   ├── 接口视图 [Huawei-GigabitEthernet0/0/0]
    │   ├── 协议视图 [Huawei-ospf-1]
    │   ├── 路由协议区域视图 [Huawei-ospf-1-area-0.0.0.0]
    │   ├── AAA视图 [Huawei-aaa]
    │   ├─��� ACL视图 [Huawei-acl-basic-2000]
    │   └── VLAN视图 [Huawei-vlan10]
```

### 1.2 命令级别与权限

```bash
# 华为设备有0-15共16个命令级别
# 级别0: 网络诊断工具命令 (ping, tracert)
# 级别1: 用于系统维护，包括display等命令
# 级别2: 业务配置命令
# 级别3-15: 用于系统基本运行、业务服务

# 查看当前用户级别
<Huawei>display user-interface
<Huawei>display this                    # 显示当前视图配置

# 设置用户级别
[Huawei]aaa
[Huawei-aaa]local-user admin privilege level 15  # 最高权限
[Huawei-aaa]local-user user1 privilege level 3   # 业务权限
[Huawei-aaa]local-user user2 privilege level 1   # 只读权限
```

### 1.3 命令行快捷键

```bash
快捷键功能详解：
Ctrl + A          # 光标移至行首
Ctrl + E          # 光标移至行末
Ctrl + B          # 光标左移一个字符
Ctrl + F          # 光标右移一个字符
Ctrl + P          # 显示上一条历史命令
Ctrl + N          # 显示下一条历史命令
Ctrl + C          # 停止当前命令执行
Ctrl + Z          # 退回到用户视图
Ctrl + ]          # 终止当前连接
Esc + B           # 光标左移一个单词
Esc + F           # 光标右移一个单词
Tab               # 命令/参数自动补全
?                 # 获取帮助信息
<Ctrl+G>          # 取消部分输入

# 命令历史设置
[Huawei]user-interface console 0
[Huawei-ui-console0]history-command max-size 50  # 历史命令缓存条数
```

### 1.4 命令行编辑模式

```bash
# 设置命令行编辑模式
[Huawei]user-interface console 0
[Huawei-ui-console0]screen-length 30           # 每屏显示行数，0为不分屏
[Huawei-ui-console0]idle-timeout 30 0          # 超时时间：30分钟0秒
[Huawei-ui-console0]history-command max-size 20

# VTY模式设置
[Huawei]user-interface vty 0 4
[Huawei-ui-vty0-4]screen-length 0              # 关闭分屏
[Huawei-ui-vty0-4]history-command max-size 30
```

---

## 二、系统基础配置

### 2.1 设备标识与信息

```bash
# 设备命名（建议规范：地区-楼层-设备类型-编号）
[Huawei]sysname BJ-F3-Router-01

# 设置设备描述信息
[BJ-F3-Router-01]description Core Router for Building 3

# 登录Banner配置
[Huawei]header login information "
****************************************
*   Authorized Access Only             *
*   Login attempts are monitored       *
*   Contact: admin@company.com         *
****************************************
"

[Huawei]header shell information "
Welcome to BJ-F3-Router-01
Last configuration: 2024-01-15
"

# 查看系统信息
<Huawei>display version                        # 查看版本详细信息
<Huawei>display device                         # 查看设备硬件信息
<Huawei>display device manufacture-info        # 查看设备制造信息
<Huawei>display esn                            # 查看设备序列号
<Huawei>display patch-information              # 查看补丁信息
```

### 2.2 时钟与NTP配置

```bash
# 手动配置时钟
[Huawei]clock timezone BJ add 08:00:00         # 设置时区（北京东八区）
[Huawei]clock datetime 14:30:00 2024-01-15    # 手动设置时间
<Huawei>display clock                          # 查看当前时间

# NTP客户端配置
[Huawei]ntp-service unicast-server 210.72.145.44    # 国家授时中心
[Huawei]ntp-service unicast-server 202.120.2.101    # 上海交大NTP
[Huawei]ntp-service unicast-server ntp.aliyun.com   # 阿里云NTP

# NTP认证配置
[Huawei]ntp-service authentication enable
[Huawei]ntp-service authentication-keyid 1 authentication-mode md5 cipher Huawei@123
[Huawei]ntp-service reliable authentication-keyid 1
[Huawei]ntp-service unicast-server 210.72.145.44 authentication-keyid 1

# NTP服务器配置
[Huawei]ntp-service enable
[Huawei]ntp-service refclock-master 3          # 本地时钟层级
[Huawei]ntp-service unicast-server 210.72.145.44
[Huawei]ntp-service max-dynamic-sessions 100   # 最大会话数

# 查看NTP状态
<Huawei>display ntp-service status
<Huawei>display ntp-service sessions
<Huawei>display ntp-service trace
```

### 2.3 配置文件管理

```bash
# 查看配置文件
<Huawei>display current-configuration          # 当前运行配置
<Huawei>display saved-configuration            # 已保存的配置
<Huawei>display configuration candidate        # 候选配置

# 查看特定部分配置
<Huawei>display current-configuration interface GigabitEthernet 0/0/0
<Huawei>display current-configuration configuration ospf
<Huawei>display current-configuration | include ip route-static

# 保存配置（多种方式）
<Huawei>save                                   # 交互式保存
<Huawei>save safely                            # 安全保存（双备份）
<Huawei>save configuration.cfg                 # 保存到指定文件
<Huawei>save vrpcfg.zip                        # 保存为zip格式

# 配置回滚
[Huawei]configuration replace file backup.cfg  # 用文件替换当前配置
<Huawei>reset saved-configuration              # 清除保存的配置

# 比较配置
<Huawei>display configuration candidate changes # 查看配置变更
<Huawei>display current-configuration diff      # 配置差异对比

# 配置文件加载
<Huawei>startup saved-configuration config.cfg  # 设置下次启动配置文件
<Huawei>display startup                         # 查看启动配置文件设置
```

### 2.4 系统日志配置

```bash
# 日志信息级别（0-7，数字越小越重要）
# 0-Emergency 紧急
# 1-Alert 警报  
# 2-Critical 关键
# 3-Error 错误
# 4-Warning 警告
# 5-Notice 通知
# 6-Informational 信息
# 7-Debug 调试

# 配置日志缓冲区
[Huawei]info-center enable                     # 启用信息中心
[Huawei]info-center logbuffer size 1024        # 日志缓冲区大小（KB）

# 配置日志输出
[Huawei]info-center console log level informational
[Huawei]info-center monitor log level warnings
[Huawei]info-center logbuffer log level notifications

# 配置日志主机（Syslog服务器）
[Huawei]info-center loghost 192.168.1.100 facility local5
[Huawei]info-center loghost 192.168.1.100 port 514 facility local6

# 配置日志过滤
[Huawei]info-center filter-id 1 icmp
[Huawei]info-center source default deny filter-id 1

# 配置日志时间戳
[Huawei]info-center timestamp log date          # 仅日期
[Huawei]info-center timestamp log date-without-year  # 日期不含年份
[Huawei]info-center timestamp log date millisecond   # 毫秒级时间戳

# 查看日志
<Huawei>display logbuffer                       # 查看日志缓冲区
<Huawei>display logbuffer reverse              # 倒序显示
<Huawei>display logbuffer level errors         # 只显示错误级别
<Huawei>display info-center                    # 查看信息中心配置
```

### 2.5 License管理

```bash
# 查看License信息
<Huawei>display license
<Huawei>display license usage
<Huawei>display license resource-usage

# 激活License
[Huawei]license active file license.dat

# 删除License
[Huawei]license revoke feature-name feature-id

# 备份License
<Huawei>license backup
```

---

## 三、接口配置详解

### 3.1 物理接口配置

```bash
# 进入接口视图（多种接口类型）
[Huawei]interface GigabitEthernet 0/0/0        # 千兆以太网接口
[Huawei]interface XGigabitEthernet 0/0/0       # 万兆以太网接口
[Huawei]interface Serial 1/0/0                 # 串行接口
[Huawei]interface Eth-Trunk 1                  # 链路聚合接口

# 基本接口配置
[Huawei-GigabitEthernet0/0/0]ip address 192.168.1.1 255.255.255.0
# 或使用CIDR格式
[Huawei-GigabitEthernet0/0/0]ip address 192.168.1.1 24

# 辅助IP地址（一个接口多个IP）
[Huawei-GigabitEthernet0/0/0]ip address 192.168.1.1 24
[Huawei-GigabitEthernet0/0/0]ip address 10.0.0.1 24 sub

# 接口描述
[Huawei-GigabitEthernet0/0/0]description "Connect to Core-Switch-01 GE1/0/1"

# 启用/关闭接口
[Huawei-GigabitEthernet0/0/0]undo shutdown     # 启用接口（默认）
[Huawei-GigabitEthernet0/0/0]shutdown          # 关闭接口

# 接口速率与双工模式
[Huawei-GigabitEthernet0/0/0]speed 1000        # 设置速率（10/100/1000/auto）
[Huawei-GigabitEthernet0/0/0]duplex full       # 全双工（full/half/auto）
[Huawei-GigabitEthernet0/0/0]negotiation auto  # 自动协商

# MTU设置
[Huawei-GigabitEthernet0/0/0]mtu 1500          # 默认1500字节
[Huawei-GigabitEthernet0/0/0]jumboframe enable 9000  # 巨型帧

# 接口流量统计间隔
[Huawei-GigabitEthernet0/0/0]flow-interval 60  # 统计间隔60秒

# 接口带宽参考值（用于路由协议计算）
[Huawei-GigabitEthernet0/0/0]bandwidth-reference 1000000  # 单位kbps
```

### 3.2 子接口配置（单臂路由）

```bash
# 创建子接口实现VLAN间路由
[Huawei]interface GigabitEthernet 0/0/1.10
[Huawei-GigabitEthernet0/0/1.10]description VLAN10-Finance
[Huawei-GigabitEthernet0/0/1.10]dot1q termination vid 10   # 终结VLAN 10
[Huawei-GigabitEthernet0/0/1.10]ip address 192.168.10.1 24
[Huawei-GigabitEthernet0/0/1.10]arp broadcast enable       # 启用ARP广播

[Huawei]interface GigabitEthernet 0/0/1.20
[Huawei-GigabitEthernet0/0/1.20]description VLAN20-HR
[Huawei-GigabitEthernet0/0/1.20]dot1q termination vid 20
[Huawei-GigabitEthernet0/0/1.20]ip address 192.168.20.1 24
[Huawei-GigabitEthernet0/0/1.20]arp broadcast enable

# QinQ（VLAN嵌套）子接口
[Huawei]interface GigabitEthernet 0/0/2.100
[Huawei-GigabitEthernet0/0/2.100]dot1q termination vid 100 ce-vid 10
[Huawei-GigabitEthernet0/0/2.100]ip address 172.16.1.1 24
```

### 3.3 Loopback接口

```bash
# Loopback接口特点：
# 1. 逻辑接口，永不down
# 2. 常用作路由器ID
# 3. 用于管理访问
# 4. 测试用途

[Huawei]interface LoopBack 0
[Huawei-LoopBack0]description Router-ID-and-Management
[Huawei-LoopBack0]ip address 1.1.1.1 32        # 建议使用/32掩码

# 多个Loopback接口
[Huawei]interface LoopBack 1
[Huawei-LoopBack1]description Testing-Interface
[Huawei-LoopBack1]ip address 10.255.255.1 32

# 查看Loopback接口
<Huawei>display interface LoopBack 0
```

### 3.4 NULL接口

```bash
# NULL接口用于丢弃流量（黑洞路由）
[Huawei]interface NULL 0
[Huawei-NULL0]description Blackhole-Interface

# 配合路由使用
[Huawei]ip route-static 192.168.100.0 24 NULL 0  # 丢弃目标流量

# 防止路由环路
[Huawei]ip route-static 10.0.0.0 8 NULL 0
[Huawei]ip route-static 10.1.0.0 16 192.168.1.254
# 10.1.0.0/16走正常路由，其他10.x.x.x丢弃
```

### 3.5 串行接口配置

```bash
# 串行接口（WAN连接）
[Huawei]interface Serial 1/0/0
[Huawei-Serial1/0/0]link-protocol ppp          # 链路协议（PPP/HDLC）
[Huawei-Serial1/0/0]ip address 192.168.100.1 30

# PPP认证
[Huawei-Serial1/0/0]ppp authentication-mode pap
# 或CHAP认证
[Huawei-Serial1/0/0]ppp authentication-mode chap

# PAP认证配置
[Huawei]interface Serial 1/0/0
[Huawei-Serial1/0/0]ppp pap local-user huawei password cipher Huawei@123

# CHAP认证配置
[Huawei-Serial1/0/0]ppp chap user huawei
[Huawei-Serial1/0/0]ppp chap password cipher Huawei@123

# 时钟速率（DCE端配置）
[Huawei-Serial1/0/0]clock rate 64000           # 单位bps

# PPP压缩
[Huawei-Serial1/0/0]ppp compression iphc enable
```

### 3.6 接口监控与统计

```bash
# 查看接口状态
<Huawei>display interface                      # 所有接口详细信息
<Huawei>display interface brief               # 所有接口简要信息
<Huawei>display interface GigabitEthernet 0/0/0  # 特定接口详细信息
<Huawei>display ip interface                   # IP接口信息
<Huawei>display ip interface brief             # IP接口简要信息

# 接口流量统计
<Huawei>display interface GigabitEthernet 0/0/0 | include rate
<Huawei>display interface counters             # 接口计数器

# 清除接口统计
<Huawei>reset counters interface GigabitEthernet 0/0/0
<Huawei>reset counters                         # 清除所有接口统计

# 接口状态监控
<Huawei>display interface main                 # 主接口状态

# 接口详细参数解读示例
<Huawei>display interface GigabitEthernet 0/0/0
# GigabitEthernet0/0/0 current state : UP       # 物理层状态
# Line protocol current state : UP              # 数据链路层状态
# Description: Connect to Core-Switch           
# The Maximum Transmit Unit is 1500 bytes       # MTU值
# Internet Address is 192.168.1.1/24           
# IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is xxxx-xxxx-xxxx
# Current system time: 2024-01-15 14:30:00
# Speed : 1000 Mbps                             # 接口速率
# Duplex: FULL                                  # 双工模式
# Last 300 seconds input:  50 packets/sec 40000 bytes/sec    # 入站流量
# Last 300 seconds output: 60 packets/sec 48000 bytes/sec    # 出站流量
# Input: 12345678 packets, 98765432 bytes       # 总入站数据
# Output: 23456789 packets, 87654321 bytes      # 总出站数据
```

---

## 四、静态路由高级配置

### 4.1 基础静态路由

```bash
# 标准格式
[Huawei]ip route-static 目标网络 掩码 下一跳IP [preference] [tag] [description]

# 基本示例
[Huawei]ip route-static 10.0.0.0 255.255.255.0 192.168.1.254
[Huawei]ip route-static 10.0.0.0 24 192.168.1.254              # CIDR格式

# 指定出接口
[Huawei]ip route-static 172.16.0.0 16 GigabitEthernet 0/0/1

# 出接口+下一跳（推荐用于以太网）
[Huawei]ip route-static 172.16.0.0 16 GigabitEthernet 0/0/1 192.168.1.254

# 默认路由（网关路由）
[Huawei]ip route-static 0.0.0.0 0.0.0.0 192.168.1.1
# 或简写
[Huawei]ip route-static 0.0.0.0 0 192.168.1.1

# 永久路由（设备重启后仍存在）
[Huawei]ip route-static 10.0.0.0 24 192.168.1.254 permanent

# 带描述的路由
[Huawei]ip route-static 10.0.0.0 24 192.168.1.254 description To-Branch-Office
```

### 4.2 路由优先级（Preference）

```bash
# 华为路由器路由优先级（数值越小优先级越高）
# Direct     0    # 直连路由
# OSPF       10   # OSPF路由
# IS-IS      15   # IS-IS路由
# Static     60   # 静态路由
# RIP        100  # RIP路由
# OSPF-ASE   150  # OSPF外部路由
# BGP        255  # BGP路由

# 设置静态路由优先级
[Huawei]ip route-static 10.0.0.0 24 192.168.1.1 preference 50
[Huawei]ip route-static 10.0.0.0 24 192.168.2.1 preference 100

# 查看路由优先级
<Huawei>display ip routing-table protocol static
```

### 4.3 浮动静态路由（路由备份）

```bash
# 主路由
[Huawei]ip route-static 192.168.10.0 24 10.0.0.1 preference 60
# 备份路由
[Huawei]ip route-static 192.168.10.0 24 10.0.0.2 preference 80

# 主链路故障时自动切换到备份链路
# 实际案例：双ISP出口
[Huawei]ip route-static 0.0.0.0 0 200.1.1.1 preference 60 description Primary-ISP
[Huawei]ip route-static 0.0.0.0 0 202.1.1.1 preference 80 description Backup-ISP

# 配合BFD实现快速检测
[Huawei]ip route-static 10.0.0.0 24 192.168.1.1 track bfd-session 1
```

### 4.4 等价路由（负载均衡）

```bash
# 配置多条相同目标、相同优先级的路由
[Huawei]ip route-static 172.16.0.0 16 192.168.1.1 preference 60
[Huawei]ip route-static 172.16.0.0 16 192.168.2.1 preference 60
[Huawei]ip route-static 172.16.0.0 16 192.168.3.1 preference 60

# 最多支持8条等价路由
# 流量按源、目的IP的哈希值分配

# 查看负载分担
<Huawei>display ip routing-table 172.16.0.0 verbose
```

### 4.5 递归路由

```bash
# 下一跳非直连网络，需要递归查找
[Huawei]ip route-static 10.0.0.0 24 192.168.100.1
[Huawei]ip route-static 192.168.100.0 30 172.16.0.1

# 路由递归过程：
# 1. 查找10.0.0.0/24的下一跳192.168.100.1
# 2. 递归查找192.168.100.1的路由
# 3. 找到192.168.100.0/30经172.16.0.1
# 4. 最终出接口由172.16.0.1所在路由决定
```

### 4.6 黑洞路由

```bash
# 丢弃特定流量
[Huawei]ip route-static 192.168.50.0 24 NULL 0

# 防止路由环路的汇总路由
[Huawei]ip route-static 10.0.0.0 8 NULL 0 preference 80
[Huawei]ip route-static 10.1.0.0 16 192.168.1.1 preference 60
[Huawei]ip route-static 10.2.0.0 16 192.168.1.2 preference 60
# 已知明细路由优先，未知的10.x.x.x网段丢弃
```

### 4.7 路由策略控制

```bash
# 配合Tag实现路由过滤
[Huawei]ip route-static 10.0.0.0 24 192.168.1.1 tag 100

# 在路由策略中使用Tag
[Huawei]route-policy STATIC-FILTER permit node 10
[Huawei-route-policy]if-match tag 100
[Huawei-route-policy]apply cost 20
```

### 4.8 BFD联动（快速故障检测）

```bash
# 配置BFD会话
[Huawei]bfd
[Huawei-bfd]quit

[Huawei]bfd session1 bind peer-ip 192.168.1.254 interface GigabitEthernet0/0/0
[Huawei-bfd-session-session1]discriminator local 1
[Huawei-bfd-session-session1]discriminator remote 1
[Huawei-bfd-session-session1]commit

# 静态路由绑定BFD
[Huawei]ip route-static 10.0.0.0 24 192.168.1.254 track bfd-session session1

# BFD检测到链路故障，自动切换到备份路由
```

### 4.9 路由管理

```bash
# 查看路由表
<Huawei>display ip routing-table                    # 完整路由表
<Huawei>display ip routing-table protocol static    # 仅静态路由
<Huawei>display ip routing-table 10.0.0.0          # 特定目标
<Huawei>display ip routing-table verbose           # 详细信息
<Huawei>display ip routing-table statistics        # 统计信息

# 删除静态路由
[Huawei]undo ip route-static 10.0.0.0 24 192.168.1.1

# 删除所有静态路由
[Huawei]undo ip route-static all

# 路由表详解示例
<Huawei>display ip routing-table
# Route Flags: R - relay, D - download to fib
# Routing Tables: Public
#         Destinations : 15       Routes : 15
# 
# Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface
# 0.0.0.0/0          Static  60   0          RD   192.168.1.1    GE0/0/0
# 10.0.0.0/24        Static  60   0          RD   192.168.1.254  GE0/0/0
# 127.0.0.0/8        Direct  0    0          D    127.0.0.1      InLoop0
# 192.168.1.0/24     Direct  0    0          D    192.168.1.2    GE0/0/0
# 192.168.1.2/32     Direct  0    0          D    127.0.0.1      GE0/0/0
```

---

## 五、动态路由协议详解

### 5.1 RIP配置详解

```bash
# RIP基本配置
[Huawei]rip 1                                   # 进程号，本地有效
[Huawei-rip-1]version 2                        # RIP版本（默认v1）
[Huawei-rip-1]network 192.168.1.0              # 宣告网络
[Huawei-rip-1]network 10.0.0.0
[Huawei-rip-1]undo summary                     # 关闭自动汇总

# RIP高级配置
[Huawei-rip-1]preference 100                   # 路由优先级
[Huawei-rip-1]default-route originate          # 发布默认路由
[Huawei-rip-1]silent-interface GigabitEthernet 0/0/2  # 被动接口

# 定时器配置
[Huawei-rip-1]timers rip 30 180 120           # update、timeout、garbage

# 认证配置
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]rip authentication-mode simple cipher Huawei123
# 或MD5认证
[Huawei-GigabitEthernet0/0/0]rip authentication-mode md5 usual cipher Huawei@123

# 路由过滤
[Huawei-rip-1]filter-policy 2000 import        # 入站过滤
[Huawei-rip-1]filter-policy 2001 export        # 出站过滤

# 路由汇总（手动）
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]rip summary-address 172.16.0.0 255.255.0.0

# 单播更新
[Huawei-rip-1]peer 192.168.1.2                # 单播邻居

# 最大跳数
[Huawei-rip-1]maximum load-balancing 4         # 等价路由条数

# 查看RIP信息
<Huawei>display rip 1
<Huawei>display rip 1 route                    # RIP路由表
<Huawei>display rip 1 database                 # RIP数据库
<Huawei>display rip 1 interface                # RIP接口信息
<Huawei>display rip 1 statistics               # RIP统计信息
```

### 5.2 OSPF配置详解

```bash
# OSPF基本配置
[Huawei]ospf 1 router-id 1.1.1.1              # 进程号+Router ID
[Huawei-ospf-1]area 0                          # 进入区域视图
[Huawei-ospf-1-area-0.0.0.0]network 192.168.1.0 0.0.0.255
[Huawei-ospf-1-area-0.0.0.0]network 10.0.0.0 0.255.255.255

# 或在接口下启用OSPF
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]ospf enable 1 area 0

# OSPF区域类型
[Huawei-ospf-1]area 1                          # 标准区域
[Huawei-ospf-1-area-0.0.0.1]stub              # 末节区域
[Huawei-ospf-1-area-0.0.0.1]stub no-summary   # 完全末节
[Huawei-ospf-1-area-0.0.0.2]nssa              # NSSA区域
[Huawei-ospf-1-area-0.0.0.2]nssa no-summary   # 完全NSSA

# 网络类型
[Huawei-GigabitEthernet0/0/0]ospf network-type broadcast    # 广播型
[Huawei-GigabitEthernet0/0/0]ospf network-type p2p          # 点对点
[Huawei-GigabitEthernet0/0/0]ospf network-type nbma         # NBMA
[Huawei-GigabitEthernet0/0/0]ospf network-type p2mp         # 点对多点

# OSPF优先级与选举
[Huawei-GigabitEthernet0/0/0]ospf dr-priority 100   # DR优先级（0-255）

# OSPF开销（Cost）
[Huawei-GigabitEthernet0/0/0]ospf cost 10           # 手动设置Cost
[Huawei-ospf-1]bandwidth-reference 1000             # 带宽参考值

# OSPF定时器
[Huawei-GigabitEthernet0/0/0]ospf timer hello 10    # Hello间隔
[Huawei-GigabitEthernet0/0/0]ospf timer dead 40     # Dead间隔

# OSPF认证
# 区域认证
[Huawei-ospf-1-area-0.0.0.0]authentication-mode simple cipher Huawei123
[Huawei-ospf-1-area-0.0.0.0]authentication-mode md5 1 cipher Huawei@123

# 接口认证（优先级高于区域）
[Huawei-GigabitEthernet0/0/0]ospf authentication-mode md5 1 cipher Huawei@123

# 默认路由发布
[Huawei-ospf-1]default-route-advertise           # 无条件发布
[Huawei-ospf-1]default-route-advertise always    # 始终发布
[Huawei-ospf-1]default-route-advertise cost 10 type 1

# 路由汇总
# ABR汇总（区域间）
[Huawei-ospf-1-area-0.0.0.1]abr-summary 172.16.0.0 255.255.0.0
# ASBR汇总（外部路由）
[Huawei-ospf-1]asbr-summary 10.0.0.0 255.0.0.0

# 路由引入
[Huawei-ospf-1]import-route static               # 引入静态路由
[Huawei-ospf-1]import-route rip 1                # 引入RIP
[Huawei-ospf-1]import-route direct               # 引入直连路由

# 被动接口
[Huawei-GigabitEthernet0/0/2]ospf enable 1 area 0
[Huawei-GigabitEthernet0/0/2]ospf silent-interface

# 虚链路（连接非骨干区域到区域0）
[Huawei-ospf-1-area-0.0.0.1]vlink-peer 2.2.2.2

# OSPF GR（优雅重启）
[Huawei-ospf-1]graceful-restart
[Huawei-ospf-1]graceful-restart interval 120

# 查看OSPF信息
<Huawei>display ospf peer                        # OSPF邻居
<Huawei>display ospf peer brief                  # 邻居简要信息
<Huawei>display ospf interface                   # OSPF接口
<Huawei>display ospf routing                     # OSPF路由表
<Huawei>display ospf lsdb                        # 链路状态数据库
<Huawei>display ospf lsdb router                 # Router LSA
<Huawei>display ospf lsdb network                # Network LSA
<Huawei>display ospf abr-asbr                    # ABR/ASBR信息
<Huawei>display ospf error                       # OSPF错误统计

# OSPF故障排查
<Huawei>debugging ospf packet                    # 调试OSPF报文
<Huawei>debugging ospf event                     # 调试OSPF事件
<Huawei>debugging ospf lsa                       # 调试LSA
```

### 5.3 IS-IS配置详解

```bash
# IS-IS基本配置
[Huawei]isis 1                                   # 创建IS-IS进程
[Huawei-isis-1]network-entity 49.0001.0000.0000.0001.00  # NET地址
[Huawei-isis-1]is-level level-2                 # 设置路由器级别

# 接口启用IS-IS
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]isis enable 1
[Huawei-GigabitEthernet0/0/0]isis circuit-type p2p

# IS-IS认证
[Huawei-isis-1]area-authentication-mode md5 cipher Huawei@123
[Huawei-isis-1]domain-authentication-mode md5 cipher Huawei@123

# 路由汇总
[Huawei-isis-1]summary 172.16.0.0 255.255.0.0 level-2

# 默认路由
[Huawei-isis-1]default-route-advertise level-2

# 查看IS-IS
<Huawei>display isis peer
<Huawei>display isis route
<Huawei>display isis lsdb
```

### 5.4 BGP配置详解

```bash
# BGP基本配置
[Huawei]bgp 65001                                # 本地AS号
[Huawei-bgp]router-id 1.1.1.1                   # Router ID
[Huawei-bgp]peer 2.2.2.2 as-number 65002        # EBGP邻居
[Huawei-bgp]peer 3.3.3.3 as-number 65001        # IBGP邻居

# 宣告网络
[Huawei-bgp]network 192.168.1.0 255.255.255.0

# 对等体组配置
[Huawei-bgp]group IBGP internal                 # 内部对等体组
[Huawei-bgp]peer IBGP connect-interface LoopBack 0
[Huawei-bgp]peer 3.3.3.3 group IBGP
[Huawei-bgp]peer 4.4.4.4 group IBGP

# 路由反射器
[Huawei-bgp]peer 3.3.3.3 reflect-client         # 配置RR客户端
[Huawei-bgp]reflector cluster-id 1.1.1.1        # 簇ID

# BGP联盟
[Huawei-bgp]confederation id 100
[Huawei-bgp]confederation peer-as 65002 65003

# BGP认证
[Huawei-bgp]peer 2.2.2.2 password cipher Huawei@123

# BGP定时器
[Huawei-bgp]peer 2.2.2.2 timer keepalive 60 hold 180

# 路由策略
[Huawei-bgp]peer 2.2.2.2 route-policy RP-IN import
[Huawei-bgp]peer 2.2.2.2 route-policy RP-OUT export

# BGP路径属性
[Huawei-bgp]peer 2.2.2.2 next-hop-local         # 修改下一跳为本地
[Huawei-bgp]peer 2.2.2.2 default-route-advertise  # 发布默认路由

# MED、Local-Pref
[Huawei]route-policy SET-MED permit node 10
[Huawei-route-policy]apply cost 100

[Huawei]route-policy SET-LP permit node 10
[Huawei-route-policy]apply local-preference 200

# AS-Path过滤
[Huawei]ip as-path-filter 1 permit ^65002_
[Huawei-bgp]peer 2.2.2.2 as-path-filter 1 import

# Community
[Huawei-route-policy]apply community 100:1

# 最大前缀数
[Huawei-bgp]peer 2.2.2.2 route-limit 1000 80

# BGP4+（IPv6）
[Huawei-bgp]ipv6-family
[Huawei-bgp-af-ipv6]peer 2001::2 enable
[Huawei-bgp-af-ipv6]network 2001:db8::/32

# 查看BGP
<Huawei>display bgp peer                         # BGP邻居
<Huawei>display bgp routing-table                # BGP路由表
<Huawei>display bgp routing-table peer 2.2.2.2 advertised-routes  # 发送的路由
<Huawei>display bgp routing-table peer 2.2.2.2 received-routes    # 接收的路由
<Huawei>display bgp paths                        # AS路径
<Huawei>display bgp community                    # Community信息
```

---

## 六、访问控制列表（ACL）

### 6.1 基本ACL（2000-2999）

```bash
# 仅可匹配源IP地址
[Huawei]acl 2000
[Huawei-acl-basic-2000]description Block-Malicious-Hosts
[Huawei-acl-basic-2000]rule 5 deny source 192.168.1.100 0
[Huawei-acl-basic-2000]rule 10 deny source 192.168.1.0 0.0.0.31
[Huawei-acl-basic-2000]rule 15 permit source 192.168.1.0 0.0.0.255
[Huawei-acl-basic-2000]rule 20 deny source any

# 规则编号说明：
# 规则号范围：0-4294967294
# 步长默认为5
# 规则号越小，优先级越高

# 修改规则
[Huawei-acl-basic-2000]rule 5 deny source 192.168.1.101 0  # 覆盖规则5

# 删除规则
[Huawei-acl-basic-2000]undo rule 10

# 修改步长
[Huawei-acl-basic-2000]step 10

# 在接口应用ACL
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]traffic-filter inbound acl 2000   # 入站
[Huawei-GigabitEthernet0/0/0]traffic-filter outbound acl 2000  # 出站
```

### 6.2 高级ACL（3000-3999）

```bash
# 可匹配源/目的IP、协议、端口等
[Huawei]acl 3000
[Huawei-acl-adv-3000]description Security-Policy

# 拒绝特定主机访问Web服务器
[Huawei-acl-adv-3000]rule 5 deny tcp source 192.168.1.100 0 destination 10.0.0.10 0 destination-port eq 80

# 允许内网访问外网HTTP/HTTPS
[Huawei-acl-adv-3000]rule 10 permit tcp source 192.168.0.0 0.0.255.255 destination any destination-port eq 80
[Huawei-acl-adv-3000]rule 15 permit tcp source 192.168.0.0 0.0.255.255 destination any destination-port eq 443

# 允许DNS查询
[Huawei-acl-adv-3000]rule 20 permit udp source any destination any destination-port eq 53

# 允许ICMP
[Huawei-acl-adv-3000]rule 25 permit icmp source any destination any

# 允许已建立的连接
[Huawei-acl-adv-3000]rule 30 permit tcp source any destination any tcp-flag ack

# 端口范围
[Huawei-acl-adv-3000]rule 35 permit tcp source any destination any destination-port range 20 21  # FTP

# ICMP类型匹配
[Huawei-acl-adv-3000]rule 40 deny icmp source any destination any icmp-type echo  # 禁ping

# 时间范围
[Huawei]time-range work-time 08:00 to 18:00 working-day
[Huawei-acl-adv-3000]rule 45 deny ip source any destination any time-range work-time

# 报文分片
[Huawei-acl-adv-3000]rule 50 deny ip source any destination any fragment

# 记录日志
[Huawei-acl-adv-3000]rule 55 deny ip source any destination any logging
```

### 6.3 二层ACL（4000-4999）

```bash
# 匹配二层信息（MAC地址、VLAN、以太网类型等）
[Huawei]acl 4000
[Huawei-acl-L2-4000]rule deny source-mac 0011-2233-4455 ffff-ffff-ffff
[Huawei-acl-L2-4000]rule permit source-mac any destination-mac any

# 匹配VLAN
[Huawei-acl-L2-4000]rule deny vlan 100

# 匹配以太网类型
[Huawei-acl-L2-4000]rule deny type 0x0800  # IPv4
```

### 6.4 用户ACL（6000-9999）

```bash
# 基于用户进行过滤（需配合AAA）
[Huawei]acl 6000
[Huawei-acl-ucl-6000]rule deny source ucl-group admins
[Huawei-acl-ucl-6000]rule permit source ucl-group users
```

### 6.5 ACL高级应用

```bash
# 1. 配合NAT使用
[Huawei]acl 2001
[Huawei-acl-basic-2001]rule permit source 192.168.0.0 0.0.255.255
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat outbound 2001

# 2. 配合路由策略
[Huawei]route-policy RP permit node 10
[Huawei-route-policy]if-match acl 2000
[Huawei-route-policy]apply cost 20

# 3. 配合QoS
[Huawei]traffic classifier TC1
[Huawei-classifier-TC1]if-match acl 3000
[Huawei]traffic behavior TB1
[Huawei-behavior-TB1]car cir 10000
[Huawei]traffic policy TP1
[Huawei-trafficpolicy-TP1]classifier TC1 behavior TB1

# 4. 配合防火墙（Packet-Filter）
[Huawei]firewall zone trust
[Huawei-zone-trust]add interface GigabitEthernet 0/0/0
[Huawei]firewall zone untrust
[Huawei-zone-untrust]add interface GigabitEthernet 0/0/1
[Huawei]security-policy
[Huawei-policy-security]rule name permit-http
[Huawei-policy-security-rule-permit-http]source-zone trust
[Huawei-policy-security-rule-permit-http]destination-zone untrust
[Huawei-policy-security-rule-permit-http]source-address 192.168.1.0 24
[Huawei-policy-security-rule-permit-http]action permit

# 5. 配合Telnet/SSH访问控制
[Huawei]acl 2002
[Huawei-acl-basic-2002]rule permit source 192.168.100.0 0.0.0.255
[Huawei]user-interface vty 0 4
[Huawei-ui-vty0-4]acl 2002 inbound
```

### 6.6 ACL查看与管理

```bash
# 查看ACL配置
<Huawei>display acl all                          # 所有ACL
<Huawei>display acl 2000                         # 特定ACL
<Huawei>display acl 3000 verbose                 # 详细信息

# 查看ACL应用
<Huawei>display traffic-filter applied-record    # ACL应用位置
<Huawei>display traffic-filter statistics interface GigabitEthernet 0/0/0  # 统计

# 复制ACL
[Huawei]acl copy 2000 to 2010

# 清除ACL统计
<Huawei>reset acl counter 3000

# ACL命中率查看
<Huawei>display acl 3000
# acl advanced 3000
#  rule 5 deny tcp source 192.168.1.100 0 destination 10.0.0.10 0 (12 matches)
#  rule 10 permit tcp source any destination any (1508 matches)
```

---

## 七、NAT技术详解

### 7.1 静态NAT（一对一）

```bash
# 内网服务器对外发布
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat static global 202.1.1.10 inside 192.168.1.10
[Huawei-GigabitEthernet0/0/1]nat static global 202.1.1.11 inside 192.168.1.11

# 指定协议和端口的静态NAT
[Huawei-GigabitEthernet0/0/1]nat static protocol tcp global 202.1.1.10 8080 inside 192.168.1.10 80

# 网段静态NAT
[Huawei-GigabitEthernet0/0/1]nat static global 202.1.1.0 255.255.255.0 inside 192.168.1.0 255.255.255.0

# 查看静态NAT
<Huawei>display nat static
```

### 7.2 动态NAT（地址池）

```bash
# 创建公网IP地址池
[Huawei]nat address-group 1 202.1.1.100 202.1.1.200
[Huawei]nat address-group 2 202.1.2.1 202.1.2.254

# 定义需要转换的内网地址（ACL）
[Huawei]acl 2001
[Huawei-acl-basic-2001]rule permit source 192.168.1.0 0.0.0.255
[Huawei-acl-basic-2001]rule permit source 192.168.2.0 0.0.0.255

# 在出接口应用NAT
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat outbound 2001 address-group 1

# 不使用地址池（NAPT/PAT）
[Huawei-GigabitEthernet0/0/1]nat outbound 2001

# NAT优先级
[Huawei-GigabitEthernet0/0/1]nat outbound 2001 address-group 1 no-pat
[Huawei-GigabitEthernet0/0/1]nat outbound 2002 address-group 2
```

### 7.3 NAPT/PAT（端口复用）

```bash
# Easy IP（接口IP地址转换）
[Huawei]acl 2003
[Huawei-acl-basic-2003]rule permit source 192.168.0.0 0.0.255.255

[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat outbound 2003  # 使用接口IP

# NAPT with地址池
[Huawei]nat address-group 10 202.1.1.50 202.1.1.60
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat outbound 2003 address-group 10

# 会话数限制
[Huawei]nat session-limit total enable 100000
[Huawei]nat session-limit source-based 192.168.1.100 enable 1000
```

### 7.4 NAT Server（端口映射）

```bash
# 将外网访问映射到内网服务器
# 格式：nat server protocol 协议 global 外部IP 端口 inside 内部IP 端口

# 映射Web服务器
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 80 inside 192.168.1.10 80

# 映射邮件服务器
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 25 inside 192.168.1.20 25
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 110 inside 192.168.1.20 110

# 映射RDP（远程桌面）
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 3389 inside 192.168.1.30 3389

# 映射SSH（非标准端口）
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 2222 inside 192.168.1.40 22

# ACL限制访问源
[Huawei]acl 3001
[Huawei-acl-adv-3001]rule permit tcp source 1.1.1.0 0.0.0.255 destination 202.1.1.100 0
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.100 80 inside 192.168.1.10 80 acl 3001

# 查看NAT Server
<Huawei>display nat server
```

### 7.5 NAT ALG（应用层网关）

```bash
# NAT ALG支持的协议
# FTP、DNS、PPTP、SIP、H.323、RTSP、ILS等

# 启用NAT ALG
[Huawei]nat alg ftp enable
[Huawei]nat alg dns enable
[Huawei]nat alg pptp enable
[Huawei]nat alg sip enable

# 查看NAT ALG
<Huawei>display nat alg
```

### 7.6 NAT会话管理

```bash
# 查看NAT会话
<Huawei>display nat session all                  # 所有会话
<Huawei>display nat session protocol tcp         # TCP会话
<Huawei>display nat session source-address 192.168.1.10  # 特定源
<Huawei>display nat session verbose              # 详细信息

# 会话老化时间
[Huawei]nat session-timeout tcp 3600             # TCP会话超时
[Huawei]nat session-timeout udp 300              # UDP会话超时
[Huawei]nat session-timeout icmp 60              # ICMP会话超时

# 清除NAT会话
<Huawei>reset nat session all
<Huawei>reset nat session source-address 192.168.1.10

# NAT统计信息
<Huawei>display nat statistics
<Huawei>display nat address-group 1

# NAT日志
[Huawei]info-center source NAT channel 4 log level informational
<Huawei>display nat log
```

### 7.7 双向NAT

```bash
# 同时进行源和目的NAT转换
[Huawei]acl 3010
[Huawei-acl-adv-3010]rule permit ip source 192.168.1.0 0.0.0.255 destination 10.0.0.0 0.255.255.255

[Huawei]nat address-group 20 202.1.1.100 202.1.1.200

[Huawei]interface GigabitEthernet 0/0/1
# 源NAT
[Huawei-GigabitEthernet0/0/1]nat outbound 3010 address-group 20
# 目的NAT
[Huawei-GigabitEthernet0/0/1]nat server protocol tcp global 202.1.1.50 80 inside 192.168.1.10 80
```

### 7.8 NAT 故障排查

```bash
# 诊断命令
<Huawei>display nat outbound                     # 出站NAT配置
<Huawei>display nat inbound                      # 入站NAT配置
<Huawei>display nat all                          # 所有NAT配置

# 调试NAT
<Huawei>debugging nat packet                     # NAT报文
<Huawei>debugging nat error                      # NAT错误
<Huawei>undo debugging all                       # 关闭所有调试

# 常见问题排查
# 1. 检查ACL是否匹配
<Huawei>display acl 2001

# 2. 检查地址池是否耗尽
<Huawei>display nat address-group 1

# 3. 检查会话表
<Huawei>display nat session statistics
```

---

## 八、DHCP服务配置

### 8.1 DHCP全局地址池

```bash
# 启用DHCP
[Huawei]dhcp enable

# 创建全局地址池
[Huawei]ip pool VLAN10-Pool
[Huawei-ip-pool-VLAN10-Pool]network 192.168.10.0 mask 255.255.255.0
[Huawei-ip-pool-VLAN10-Pool]gateway-list 192.168.10.1
[Huawei-ip-pool-VLAN10-Pool]dns-list 8.8.8.8 114.114.114.114
[Huawei-ip-pool-VLAN10-Pool]lease day 7 hour 0 minute 0
[Huawei-ip-pool-VLAN10-Pool]domain-name company.com

# 排除地址范围（不分配）
[Huawei-ip-pool-VLAN10-Pool]excluded-ip-address 192.168.10.1 192.168.10.10

# NETBIOS服务器
[Huawei-ip-pool-VLAN10-Pool]nbns-list 192.168.10.100

# 静态绑定
[Huawei-ip-pool-VLAN10-Pool]static-bind ip-address 192.168.10.50 mac-address 0011-2233-4455

# 在接口启用DHCP
[Huawei]interface Vlanif 10
[Huawei-Vlanif10]ip address 192.168.10.1 24
[Huawei-Vlanif10]dhcp select global                # 使用全局地址池

# Option 43配置（AP发现）
[Huawei-ip-pool-VLAN10-Pool]option 43 sub-option 3 ip-address 192.168.10.100
```

### 8.2 DHCP接口地址池

```bash
# 基于接口的DHCP（无需创建地址池）
[Huawei]dhcp enable
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]ip address 192.168.20.1 24
[Huawei-GigabitEthernet0/0/1]dhcp select interface

# 接口下配置DHCP参数
[Huawei-GigabitEthernet0/0/1]dhcp server dns-list 8.8.8.8 114.114.114.114
[Huawei-GigabitEthernet0/0/1]dhcp server lease day 3
[Huawei-GigabitEthernet0/0/1]dhcp server domain-name test.com

# 排除地址
[Huawei-GigabitEthernet0/0/1]dhcp server excluded-ip-address 192.168.20.1 192.168.20.10

# 静态绑定
[Huawei-GigabitEthernet0/0/1]dhcp server static-bind ip-address 192.168.20.100 mac-address 0011-2233-4455
```

### 8.3 DHCP中继

```bash
# DHCP Relay配置（三层设备）
[Huawei]dhcp enable

[Huawei]interface Vlanif 10
[Huawei-Vlanif10]ip address 192.168.10.1 24
[Huawei-Vlanif10]dhcp select relay
[Huawei-Vlanif10]dhcp relay server-ip 192.168.100.10    # DHCP服务器IP

# 多个DHCP服务器
[Huawei-Vlanif10]dhcp relay server-ip 192.168.100.10
[Huawei-Vlanif10]dhcp relay server-ip 192.168.100.11

# 修改网关地址（Option 3）
[Huawei-Vlanif10]dhcp relay gateway-address 192.168.10.254

# DHCP中继安全
[Huawei]dhcp snooping enable
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]dhcp snooping enable
[Huawei-GigabitEthernet0/0/1]dhcp snooping trusted  # 信任接口
```

### 8.4 DHCP Snooping

```bash
# 防御DHCP攻击
[Huawei]dhcp enable
[Huawei]dhcp snooping enable

# 全局配置
[Huawei]dhcp snooping check dhcp-chaddr enable      # 检查CHADDR字段
[Huawei]dhcp snooping check dhcp-request enable     # 检查请求报文

# 接口配置
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]dhcp snooping enable
[Huawei-GigabitEthernet0/0/1]dhcp snooping trusted  # 上行信任接口

[Huawei]interface GigabitEthernet 0/0/2
[Huawei-GigabitEthernet0/0/2]dhcp snooping enable
[Huawei-GigabitEthernet0/0/2]dhcp snooping max-user-number 10  # 限制用户数

# 查看Snooping绑定表
<Huawei>display dhcp snooping user-bind all
<Huawei>display dhcp snooping configuration
<Huawei>display dhcp snooping trusted-interface
```

### 8.5 DHCP查看与维护

```bash
# 查看地址池
<Huawei>display ip pool name VLAN10-Pool           # 特定地址池
<Huawei>display ip pool name all                   # 所有地址池
<Huawei>display ip pool interface GigabitEthernet 0/0/1

# 查看租约
<Huawei>display dhcp server statistics             # 统计信息
<Huawei>display dhcp server ip-in-use              # 已分配IP
<Huawei>display dhcp server ip-in-use pool VLAN10-Pool
<Huawei>display dhcp server expired                # 过期租约
<Huawei>display dhcp server conflict               # 冲突地址

# 清除DHCP绑定
<Huawei>reset dhcp server statistics               # 清除统计
<Huawei>reset dhcp server ip-in-use                # 清除租约
<Huawei>reset dhcp server ip-in-use pool VLAN10-Pool
<Huawei>reset dhcp server conflict                 # 清除冲突

# DHCP调试
<Huawei>debugging dhcp relay packet                # 中继报文
<Huawei>debugging dhcp server packet               # 服务器报文
<Huawei>debugging dhcp server event                # 事件
<Huawei>undo debugging all
```

### 8.6 DHCP高级特性

```bash
# DHCP地址池分组
[Huawei]ip pool Group1
[Huawei-ip-pool-Group1]section 0 192.168.10.100 192.168.10.150
[Huawei-ip-pool-Group1]section 1 192.168.10.200 192.168.10.250

# DHCP Option 82（中继代理信息）
[Huawei]interface Vlanif 10
[Huawei-Vlanif10]dhcp relay information enable
[Huawei-Vlanif10]dhcp relay information策略 replace

# DHCP Option 60（厂商类标识）
[Huawei-ip-pool-VLAN10-Pool]option 60 ascii "HUAWEI"

# DHCP Option 121（静态路由）
[Huawei-ip-pool-VLAN10-Pool]option 121 route 10.0.0.0 255.255.255.0 192.168.10.254

# DHCP Option 150（TFTP服务器，用于IP电话）
[Huawei-ip-pool-VLAN10-Pool]option 150 ip-address 192.168.10.200

# 基于Option 82分配地址
[Huawei]ip pool Option82-Pool
[Huawei-ip-pool-Option82-Pool]network 192.168.30.0 mask 255.255.255.0
[Huawei-ip-pool-Option82-Pool]option 82 circuit-id ascii "Building-A-Floor-3"
```

---

## 九、VLAN与三层交换

### 9.1 VLAN基础配置

```bash
# 创建VLAN
[Huawei]vlan batch 10 20 30                        # 批量创建VLAN
[Huawei]vlan 10
[Huawei-vlan10]description Finance-Department
[Huawei-vlan10]quit

# 将接口加入VLAN（Access模式）
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]port link-type access
[Huawei-GigabitEthernet0/0/1]port default vlan 10

# Trunk模式配置
[Huawei]interface GigabitEthernet 0/0/24
[Huawei-GigabitEthernet0/0/24]port link-type trunk
[Huawei-GigabitEthernet0/0/24]port trunk allow-pass vlan 10 20 30
# 或允许所有VLAN
[Huawei-GigabitEthernet0/0/24]port trunk allow-pass vlan all

# Hybrid模式
[Huawei]interface GigabitEthernet 0/0/2
[Huawei-GigabitEthernet0/0/2]port link-type hybrid
[Huawei-GigabitEthernet0/0/2]port hybrid untagged vlan 10 20
[Huawei-GigabitEthernet0/0/2]port hybrid tagged vlan 30

# 修改PVID（默认VLAN）
[Huawei-GigabitEthernet0/0/2]port hybrid pvid vlan 10

# 查看VLAN
<Huawei>display vlan
<Huawei>display vlan 10
<Huawei>display port vlan
<Huawei>display port vlan active
```

### 9.2 VLANIF接口（三层交换）

```bash
# 创建VLANIF接口实现VLAN间路由
[Huawei]vlan 10
[Huawei]vlan 20

[Huawei]interface Vlanif 10
[Huawei-Vlanif10]ip address 192.168.10.1 24
[Huawei-Vlanif10]description Gateway-for-VLAN10

[Huawei]interface Vlanif 20
[Huawei-Vlanif20]ip address 192.168.20.1 24
[Huawei-Vlanif20]description Gateway-for-VLAN20

# VLANIF接口其他配置
[Huawei-Vlanif10]arp-proxy enable                  # ARP代理
[Huawei-Vlanif10]arp expire-time 1200              # ARP超时
[Huawei-Vlanif10]mtu 1500

# 查看VLANIF
<Huawei>display interface Vlanif
<Huawei>display ip interface brief
```

### 9.3 Super VLAN

```bash
# Super VLAN聚合多个Sub VLAN
[Huawei]vlan 100
[Huawei-vlan100]aggregate-vlan                     # 配置为Super VLAN
[Huawei-vlan100]access-vlan 10 20                  # 关联Sub VLAN

[Huawei]interface Vlanif 100
[Huawei-Vlanif100]ip address 192.168.1.1 24       # 网关地址
[Huawei-Vlanif100]arp-proxy inner-sub-vlan-proxy enable  # 启用代理ARP

# Sub VLAN之间通信
[Huawei-vlan100]access-vlan 10 20 30
```

### 9.4 QinQ（VLAN嵌套）

```bash
# 基本QinQ
[Huawei]vlan 100
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]port link-type access
[Huawei-GigabitEthernet0/0/1]qinq vlan-translation enable
[Huawei-GigabitEthernet0/0/1]port default vlan 100

# 灵活QinQ
[Huawei]interface GigabitEthernet 0/0/2
[Huawei-GigabitEthernet0/0/2]port link-type dot1q-tunnel
[Huawei-GigabitEthernet0/0/2]port default vlan 200

# Selective QinQ
[Huawei-GigabitEthernet0/0/3]qinq vlan-translation enable
[Huawei-GigabitEthernet0/0/3]port vlan-stacking vlan 10 stack-vlan 100
[Huawei-GigabitEthernet0/0/3]port vlan-stacking vlan 20 stack-vlan 200
```

### 9.5 GVRP（VLAN动态注册）

```bash
# 启用GVRP
[Huawei]gvrp
[Huawei]interface GigabitEthernet 0/0/24
[Huawei-GigabitEthernet0/0/24]gvrp
[Huawei-GigabitEthernet0/0/24]gvrp registration normal

# GVRP定时器
[Huawei-GigabitEthernet0/0/24]gvrp timer join 200
[Huawei-GigabitEthernet0/0/24]gvrp timer leave 600
[Huawei-GigabitEthernet0/0/24]gvrp timer leaveall 10000

# 查看GVRP
<Huawei>display gvrp statistics
<Huawei>display gvrp status
```

### 9.6 MAC地址表管理

```bash
# 查看MAC地址表
<Huawei>display mac-address                        # 所有MAC
<Huawei>display mac-address vlan 10                # 特定VLAN
<Huawei>display mac-address GigabitEthernet 0/0/1  # 特定接口
<Huawei>display mac-address blackhole              # 黑洞MAC

# 静态MAC地址
[Huawei]mac-address static 0011-2233-4455 GigabitEthernet 0/0/1 vlan 10

# 黑洞MAC（丢弃该源MAC的流量）
[Huawei]mac-address blackhole 0011-2233-4466 vlan 10

# MAC地址老化时间
[Huawei]mac-address aging-time 300                 # 300秒

# MAC地址学习限制
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]mac-limit maximum 100

# 清除MAC地址表
<Huawei>reset mac-address
<Huawei>reset mac-address vlan 10
```

### 9.7 ARP管理

```bash
# 静态ARP
[Huawei]arp static 192.168.1.100 0011-2233-4455 GigabitEthernet 0/0/1 vid 10

# ARP代理
[Huawei]interface Vlanif 10
[Huawei-Vlanif10]arp-proxy enable

# ARP老化时间
[Huawei-Vlanif10]arp expire-time 1200             # 1200秒

# ARP学习限制
[Huawei-Vlanif10]arp max-learning-number 1024

# ARP防攻击
[Huawei]arp anti-attack check user-bind enable
[Huawei]arp anti-attack check fixed-mac enable

# DAI（动态ARP检测）
[Huawei]arp anti-attack gateway-duplicate enable
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]arp anti-attack check user-bind enable

# 查看ARP
<Huawei>display arp                                # 所有ARP
<Huawei>display arp vlan 10                       # 特定VLAN
<Huawei>display arp interface Vlanif 10           # 特定接口
<Huawei>display arp statistics                    # ARP统计

# 清除ARP
<Huawei>reset arp all
<Huawei>reset arp interface Vlanif 10
```

---

## 十、安全配置

### 10.1 用户认证与AAA

```bash
# AAA基本配置
[Huawei]aaa
[Huawei-aaa]local-user admin password cipher Admin@123456
[Huawei-aaa]local-user admin privilege level 15
[Huawei-aaa]local-user admin service-type ssh telnet http

# 创建多个用户
[Huawei-aaa]local-user user1 password cipher User1@123
[Huawei-aaa]local-user user1 privilege level 3
[Huawei-aaa]local-user user1 service-type telnet

# 认证方案
[Huawei-aaa]authentication-scheme default
[Huawei-aaa-authen-default]authentication-mode local

# 授权方案
[Huawei-aaa]authorization-scheme default
[Huawei-aaa-author-default]authorization-mode local

# 计费方案
[Huawei-aaa]accounting-scheme default
[Huawei-aaa-accounting-default]accounting-mode none

# 域配置
[Huawei-aaa]domain system
[Huawei-aaa-domain-system]authentication-scheme default
[Huawei-aaa-domain-system]authorization-scheme default
[Huawei-aaa-domain-system]accounting-scheme default

# RADIUS服务器
[Huawei-aaa]radius-server template radius1
[Huawei-aaa-radius-radius1]radius-server authentication 192.168.1.100 1812
[Huawei-aaa-radius-radius1]radius-server accounting 192.168.1.100 1813
[Huawei-aaa-radius-radius1]radius-server shared-key cipher Huawei@123

# 应用RADIUS
[Huawei-aaa]authentication-scheme radius1
[Huawei-aaa-authen-radius1]authentication-mode radius local  # RADIUS失败回退本地
```

### 10.2 Console与VTY安全

```bash
# Console口配置
[Huawei]user-interface console 0
[Huawei-ui-console0]authentication-mode aaa        # AAA认证
# 或密码认证
[Huawei-ui-console0]authentication-mode password
[Huawei-ui-console0]set authentication password cipher Console@123

# 超时设置
[Huawei-ui-console0]idle-timeout 10 0             # 10分钟超时
[Huawei-ui-console0]screen-length 24

# VTY配置（Telnet/SSH）
[Huawei]user-interface vty 0 4
[Huawei-ui-vty0-4]authentication-mode aaa
[Huawei-ui-vty0-4]protocol inbound ssh            # 仅允许SSH
[Huawei-ui-vty0-4]idle-timeout 30 0
[Huawei-ui-vty0-4]history-command max-size 50

# ACL限制访问源
[Huawei]acl 2010
[Huawei-acl-basic-2010]rule permit source 192.168.100.0 0.0.0.255
[Huawei-ui-vty0-4]acl 2010 inbound

# 最大VTY连接数
[Huawei]user-interface maximum-vty 5
```

### 10.3 SSH配置详解

```bash
# SSH服务端配置
[Huawei]rsa local-key-pair create                  # 生成RSA密钥对
# The key name will be: Huawei_Host
# The range of public key size is (512 ~ 2048). 
# NOTES: If the key modulus is greater than 512, it will take a few minutes.
# Input the bits in the modulus[default = 512]:2048
# Generating keys...
# ....

[Huawei]ssh server enable                          # 启用SSH服务器
[Huawei]stelnet server enable                      # 启用STelnet

# SSH版本
[Huawei]ssh server compatible-ssh1x disable        # 禁用SSHv1

# SSH认证方式
[Huawei]ssh user admin
[Huawei]ssh user admin authentication-type password  # 密码认证
# 或RSA密钥认证
[Huawei]ssh user admin authentication-type rsa
[Huawei]ssh user admin assign rsa-key admin-key

# SSH用户配置
[Huawei]aaa
[Huawei-aaa]local-user admin password cipher Admin@123456
[Huawei-aaa]local-user admin privilege level 15
[Huawei-aaa]local-user admin service-type ssh

# VTY应用
[Huawei]user-interface vty 0 4
[Huawei-ui-vty0-4]authentication-mode aaa
[Huawei-ui-vty0-4]protocol inbound ssh

# SSH高级配置
[Huawei]ssh server timeout 60                      # 认证超时
[Huawei]ssh server authentication-retries 3       # 重试次数
[Huawei]ssh server port 2222                       # 修改端口

# 公钥管理
[Huawei]rsa peer-public-key admin-key
[Huawei-rsa-public-key]public-key-code begin
[Huawei-rsa-public-key]30819F300D06092A864886F70D... # 粘贴公钥
[Huawei-rsa-public-key]public-key-code end

# SSH会话管理
<Huawei>display ssh server session               # SSH会话
<Huawei>display ssh user-information admin       # 用户信息
<Huawei>display rsa local-key-pair public        # 本地公钥

# 断开SSH会话
<Huawei>free ssh-server { all | session-id }
```

### 10.4 端口安全

```bash
# 端口安全基础配置
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]port-security enable
[Huawei-GigabitEthernet0/0/1]port-security max-mac-num 1  # 最大MAC数

# 安全动作
[Huawei-GigabitEthernet0/0/1]port-security protect-action shutdown  # 关闭端口
# 或
[Huawei-GigabitEthernet0/0/1]port-security protect-action restrict  # 限制流量

# Sticky MAC
[Huawei-GigabitEthernet0/0/1]port-security mac-address sticky
[Huawei-GigabitEthernet0/0/1]port-security mac-address sticky 0011-2233-4455 vlan 10

# 查看端口安全
<Huawei>display port-security
<Huawei>display port-security interface GigabitEthernet 0/0/1
```

### 10.5 风暴控制

```bash
# 广播风暴抑制
[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]broadcast-suppression 10  # 10%带宽

# 组播风暴抑制
[Huawei-GigabitEthernet0/0/1]multicast-suppression 20

# 未知单播风暴抑制
[Huawei-GigabitEthernet0/0/1]unicast-suppression 15

# 基于pps的风暴控制
[Huawei-GigabitEthernet0/0/1]broadcast-suppression pps 1000
```

### 10.6 IP Source Guard

```bash
# 基于DHCP Snooping的IP源防护
[Huawei]dhcp enable
[Huawei]dhcp snooping enable

[Huawei]interface GigabitEthernet 0/0/1
[Huawei-GigabitEthernet0/0/1]dhcp snooping enable
[Huawei-GigabitEthernet0/0/1]ip source check user-bind enable  # 启用IP源检查

# 静态绑定
[Huawei]ip source binding ip-address 192.168.1.100 mac-address 0011-2233-4455 interface GigabitEthernet 0/0/1 vlan 10

# 查看绑定表
<Huawei>display ip source binding
```

### 10.7 防火墙基础（ACL-based）

```bash
# 区域安全策略
[Huawei]firewall zone trust
[Huawei-zone-trust]set priority 85
[Huawei-zone-trust]add interface GigabitEthernet 0/0/1

[Huawei]firewall zone untrust
[Huawei-zone-untrust]set priority 5
[Huawei-zone-untrust]add interface GigabitEthernet 0/0/2

# 安全策略
[Huawei]security-policy
[Huawei-policy-security]rule name allow-http
[Huawei-policy-security-rule-allow-http]source-zone trust
[Huawei-policy-security-rule-allow-http]destination-zone untrust
[Huawei-policy-security-rule-allow-http]source-address 192.168.1.0 24
[Huawei-policy-security-rule-allow-http]service http
[Huawei-policy-security-rule-allow-http]action permit

# 查看安全策略
<Huawei>display security-policy rule name allow-http
<Huawei>display firewall zone
<Huawei>display firewall session table
```

### 10.8 Password Policy

```bash
# 密码策略配置
[Huawei]aaa
[Huawei-aaa]local-user admin password cipher Admin@123456

# 密码复杂度
[Huawei-aaa]local-user admin password complexity-check

# 密码最小长度
[Huawei]local-aaa-server password policy
[Huawei-aaa-pwd-policy]password min-len 8

# 密码有效期
[Huawei-aaa-pwd-policy]password expire 90           # 90天

# 密码历史
[Huawei-aaa-pwd-policy]password history record-num 5  # 记录5个历史密码

# 登录失败锁定
[Huawei-aaa]local-user admin access-limit 3         # 3次失败
[Huawei-aaa]local-user admin block-time 300         # 锁定300秒
```
