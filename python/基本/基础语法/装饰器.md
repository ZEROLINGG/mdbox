# **Python è£…é¥°å™¨ï¼ˆDecoratorï¼‰è¯¦è§£**

## **1. ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼Ÿ**

è£…é¥°å™¨ï¼ˆ**Decorator**ï¼‰æ˜¯ä¸€ç§**ç”¨äºä¿®æ”¹å‡½æ•°æˆ–ç±»è¡Œä¸ºçš„é«˜é˜¶å‡½æ•°**ï¼Œå®ƒ**ä¸æ”¹å˜åŸå§‹å‡½æ•°çš„ä»£ç **ï¼Œè€Œæ˜¯åœ¨**å‡½æ•°æ‰§è¡Œå‰åæ·»åŠ é¢å¤–çš„åŠŸèƒ½**ã€‚

**æ ¸å¿ƒæ€æƒ³ï¼š**

- **Python å‡½æ•°æ˜¯ä¸€ç­‰å¯¹è±¡**ï¼ˆå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€è¿”å›ï¼‰ã€‚
- **è£…é¥°å™¨æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°**ï¼Œå®ƒ**æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°**ï¼Œç„¶åè¿”å›**ä¿®æ”¹åçš„æ–°å‡½æ•°**ã€‚

---

## **2. è£…é¥°å™¨çš„åŸºæœ¬ç»“æ„**

è£…é¥°å™¨é€šå¸¸ä½¿ç”¨ `@decorator_name` è¯­æ³•ç³–ï¼Œä¹Ÿå¯ä»¥ç”¨æ‰‹åŠ¨æ–¹å¼è°ƒç”¨ã€‚

```
def my_decorator(func):
    def wrapper():
        print("æ‰§è¡Œå‰")
        func()
        print("æ‰§è¡Œå")
    return wrapper

@my_decorator  # ç­‰ä»·äº hello = my_decorator(hello)
def hello():
    print("Hello, world!")

hello()
```

**æ‰§è¡Œç»“æœï¼š**

```
æ‰§è¡Œå‰
Hello, world!
æ‰§è¡Œå
```

**ç­‰ä»·äºï¼š**

```
def hello():
    print("Hello, world!")

decorated_hello = my_decorator(hello)
decorated_hello()
```

---

## **3. è£…é¥°å™¨çš„ä½œç”¨**

ğŸ”¹ **åœ¨ä¸ä¿®æ”¹åŸå‡½æ•°ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ·»åŠ åŠŸèƒ½**ï¼ˆå¦‚æ—¥å¿—ã€æƒé™éªŒè¯ã€è®¡æ—¶ç­‰ï¼‰ã€‚  
ğŸ”¹ **æé«˜ä»£ç å¤ç”¨æ€§**ï¼ˆå¤šä¸ªå‡½æ•°å¯ä»¥å¤ç”¨åŒä¸€ä¸ªè£…é¥°å™¨ï¼‰ã€‚  
ğŸ”¹ **ç¬¦åˆ"å¼€æ”¾å°é—­åŸåˆ™"**ï¼ˆOCPï¼Œ**å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­**ï¼‰ã€‚

---

## **4. å¸¦å‚æ•°çš„è£…é¥°å™¨**

å¦‚æœåŸå§‹å‡½æ•°**å¸¦å‚æ•°**ï¼Œè£…é¥°å™¨çš„ `wrapper` ä¹Ÿè¦æ”¯æŒå‚æ•°ï¼š

```
def my_decorator(func):
    def wrapper(*args, **kwargs):  # æ”¯æŒä»»æ„å‚æ•°
        print("æ‰§è¡Œå‰")
        result = func(*args, **kwargs)
        print("æ‰§è¡Œå")
        return result
    return wrapper

@my_decorator
def add(a, b):
    return a + b

print(add(3, 5))  # å…ˆæ‰§è¡Œè£…é¥°å™¨é€»è¾‘ï¼Œå†è®¡ç®— 3 + 5
```

**æ‰§è¡Œç»“æœï¼š**

```
æ‰§è¡Œå‰
æ‰§è¡Œå
8
```

---

## **5. å¤šä¸ªè£…é¥°å™¨**

å¦‚æœæœ‰**å¤šä¸ªè£…é¥°å™¨**ï¼Œå®ƒä»¬ä¼š**ä»å†…åˆ°å¤–ä¾æ¬¡æ‰§è¡Œ**ï¼š

```
def deco1(func):
    def wrapper():
        print("deco1 æ‰§è¡Œ")
        func()
    return wrapper

def deco2(func):
    def wrapper():
        print("deco2 æ‰§è¡Œ")
        func()
    return wrapper

@deco1
@deco2
def say_hello():
    print("Hello!")

say_hello()
```

**æ‰§è¡Œé¡ºåºï¼š**

```
deco1 æ‰§è¡Œ
deco2 æ‰§è¡Œ
Hello!
```

**è¯´æ˜**ï¼š`@deco1` åŒ…è£¹ `@deco2`ï¼Œæ‰€ä»¥ **deco1 å…ˆæ‰§è¡Œï¼Œdeco2 åæ‰§è¡Œ**ã€‚

---

## **6. å¸¦å‚æ•°çš„è£…é¥°å™¨**

å¦‚æœ**è£…é¥°å™¨æœ¬èº«éœ€è¦å‚æ•°**ï¼Œåˆ™éœ€è¦**å¤šåµŒå¥—ä¸€å±‚å‡½æ•°**ã€‚

```
def repeat(n):  # è£…é¥°å™¨å·¥å‚
    def decorator(func):
        def wrapper(*args, **kwargs):
            for _ in range(n):
                func(*args, **kwargs)
        return wrapper
    return decorator

@repeat(3)
def greet():
    print("Hello!")

greet()
```

**æ‰§è¡Œç»“æœï¼š**

```
Hello!
Hello!
Hello!
```

**è¯´æ˜**ï¼š`repeat(3)` è¿”å› `decorator`ï¼Œç„¶å `decorator(greet)` ç”Ÿæˆ `wrapper`ã€‚

---

## **7.** `**functools.wraps**` **ä¿ç•™åŸå‡½æ•°ä¿¡æ¯**

è£…é¥°å™¨é»˜è®¤ä¼š**è¦†ç›–åŸå‡½æ•°çš„** `**__name__**` **å’Œ** `**__doc__**`ï¼Œå¯ä»¥ç”¨ `functools.wraps()` è§£å†³ã€‚

```
import functools

def my_decorator(func):
    @functools.wraps(func)  # è®© wrapper ç»§æ‰¿ func çš„å…ƒæ•°æ®
    def wrapper(*args, **kwargs):
        print("æ‰§è¡Œå‰")
        return func(*args, **kwargs)
    return wrapper

@my_decorator
def hello():
    """è¿™æ˜¯ hello å‡½æ•°çš„æ–‡æ¡£"""
    print("Hello!")

print(hello.__name__)  # ä»ç„¶æ˜¯ hello
print(hello.__doc__)   # ä»ç„¶æ˜¯ hello çš„æ–‡æ¡£
```

---

## **8. å…¸å‹åº”ç”¨åœºæ™¯**

### **(1) è®°å½•æ—¥å¿—**

```
import time

def log_decorator(func):
    def wrapper(*args, **kwargs):
        print(f"è°ƒç”¨å‡½æ•° {func.__name__}ï¼Œå‚æ•°: {args} {kwargs}")
        return func(*args, **kwargs)
    return wrapper

@log_decorator
def add(a, b):
    return a + b

print(add(2, 3))
```

**è¾“å‡º**

```
è°ƒç”¨å‡½æ•° addï¼Œå‚æ•°: (2, 3) {}
5
```

---

### **(2) è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´**

```
import time

def timing_decorator(func):
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {end - start:.5f} ç§’")
        return result
    return wrapper

@timing_decorator
def slow_function():
    time.sleep(1)

slow_function()
```

**è¾“å‡º**

```
slow_function æ‰§è¡Œæ—¶é—´: 1.00023 ç§’
```

---

### **(3) æƒé™éªŒè¯**

```
def check_permission(user):
    def decorator(func):
        def wrapper(*args, **kwargs):
            if user != "admin":
                print("æƒé™ä¸è¶³")
                return
            return func(*args, **kwargs)
        return wrapper
    return decorator

@check_permission("admin")
def delete_database():
    print("æ•°æ®åº“å·²åˆ é™¤ï¼")

delete_database()  # admin æœ‰æƒé™
```

---

## **9. ç±»è£…é¥°å™¨**

ç±»ä¹Ÿå¯ä»¥ä½œä¸ºè£…é¥°å™¨ï¼Œä½¿ç”¨ `__call__` æ–¹æ³•ã€‚

```
class Logger:
    def __init__(self, func):
        self.func = func

    def __call__(self, *args, **kwargs):
        print(f"è°ƒç”¨å‡½æ•° {self.func.__name__}")
        return self.func(*args, **kwargs)

@Logger
def say_hello():
    print("Hello!")

say_hello()
```

**æ‰§è¡Œç»“æœ**

```
è°ƒç”¨å‡½æ•° say_hello
Hello!
```

---

## **10. æ€»ç»“**

|   |   |
|---|---|
|ç‰¹æ€§|è¯´æ˜|
|**åŸºæœ¬è£…é¥°å™¨**|`@decorator`<br><br>è¯­æ³•ç³–ï¼ŒåŒ…è£…å‡½æ•°é€»è¾‘|
|**æ”¯æŒå‚æ•°**|ç”¨ `*args, **kwargs`<br><br>å…¼å®¹ä»»æ„å‚æ•°|
|**å¤šä¸ªè£…é¥°å™¨**|ä»å†…åˆ°å¤–ä¾æ¬¡æ‰§è¡Œ|
|**è£…é¥°å™¨å·¥å‚**|å…è®¸è£…é¥°å™¨æ¥å—å‚æ•°ï¼ˆå¤šåµŒå¥—ä¸€å±‚ï¼‰|
|`**functools.wraps**`|ä¿æŒåŸå‡½æ•° `__name__`<br><br>å’Œ `__doc__`|
|**åº”ç”¨åœºæ™¯**|è®¡æ—¶ã€æ—¥å¿—ã€æƒé™éªŒè¯ç­‰|